<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StormShield</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: Arial, Helvetica, sans-serif; background: #eef3f8; color: #333; text-align: center; }
    header { background: #003366; color: white; padding: 1.25rem; }
    nav { display: flex; justify-content: center; gap: 1rem; background: #d7e3f0; padding: 0.5rem; }
    nav button { background: none; border: none; padding: 0.6rem 1rem; cursor: pointer; }
    nav button.active { border-bottom: 3px solid #003366; font-weight: bold; }
    section { display: none; padding: 1.5rem; }
    section.active { display: block; }
    .card { background: #fff; max-width: 900px; margin: 1rem auto; padding: 1.5rem; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    .status { margin-top: 0.5rem; font-weight: 600; }
    .primary { background: #003366; color: #fff; border: 0; padding: 0.7rem 1.1rem; border-radius: 8px; cursor: pointer; }
    canvas { margin-top: 1rem; }
  </style>
</head>
<body>
  <header><h1>StormShield</h1></header>
  <nav>
    <button class="active" onclick="showPage('dashboard')">Dashboard</button>
    <button onclick="showPage('settings')">Settings</button>
    <button onclick="showPage('logs')">Logs</button>
    <button onclick="showPage('about')">About</button>
  </nav>

  <section id="dashboard" class="active">
    <div class="card">
      <button class="primary" id="connectBtn">Connect to ESP32</button>
      <div class="status" id="status">Status: Not connected</div>
      <div class="status" id="data">Distance: -- | Speed: --</div>
      <div class="status" id="score">Score: -- | p: --</div>
    </div>
  </section>

  <section id="settings">
    <div class="card">
      <label for="thresholdSlider">Boundary S (p=0.5 at score=S): <span id="thresholdValue">50</span></label>
      <input type="range" id="thresholdSlider" min="0" max="100" value="50" step="1">
      <div style="margin-top: 0.7rem;">
        <button class="primary" id="preset30">Active (30)</button>
        <button class="primary" id="preset50">Balanced (50)</button>
        <button class="primary" id="preset70">Passive (70)</button>
        <button class="primary" id="buzzButton">Test Buzz</button>
      </div>
      <p style="opacity:0.85;">Lower S triggers earlier; higher S triggers later.</p>
    </div>
  </section>

  <section id="logs">
    <div class="card">
      <h3>Score Log</h3>
      <canvas id="scoreChart" height="250"></canvas>
      <ul id="scoreLog" style="text-align:left; list-style:none; max-height:300px; overflow:auto; padding-left:0;"></ul>
    </div>
  </section>

  <section id="about">
    <div class="card">
      <h3>About</h3>
      <p>Risk is computed on the ESP32 and streamed via BLE. The web app only displays firmware-provided values.</p>
    </div>
  </section>

  <script>
    function showPage(id) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      const btn = Array.from(document.querySelectorAll('nav button')).find(b => b.textContent.toLowerCase().includes(id.toLowerCase()));
      if (btn) btn.classList.add('active');
      if (id === 'logs') setTimeout(() => scoreChart.resize(), 200);
    }

    // UUIDs must match firmware
    const serviceUUID = 'cda3dd4c-e224-4a47-93d3-7c7ccf77e5ad';
    const characteristicUUID = '79e3ff4d-b3e1-4cc1-9096-5c1cbe0a1493';

    let device, server, characteristic;
    const connectBtn = document.getElementById('connectBtn');
    const statusEl = document.getElementById('status');
    const dataEl = document.getElementById('data');
    const scoreEl = document.getElementById('score');
    const thresholdSlider = document.getElementById('thresholdSlider');
    const thresholdValue = document.getElementById('thresholdValue');
    const scoreLog = document.getElementById('scoreLog');

    const ctx = document.getElementById('scoreChart').getContext('2d');
    const chartData = { labels: [], datasets: [{ label: 'Score', data: [], borderColor: '#003366', backgroundColor: 'rgba(0,51,102,0.1)', fill: true, tension: 0.25, pointRadius: 2 }] };
    const scoreChart = new Chart(ctx, { type: 'line', data: chartData, options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } } });

    connectBtn.onclick = async () => {
      try {
        device = await navigator.bluetooth.requestDevice({ filters: [{ services: [serviceUUID] }] });
        statusEl.textContent = 'Status: Connecting...';
        server = await device.gatt.connect();
        const service = await server.getPrimaryService(serviceUUID);
        characteristic = await service.getCharacteristic(characteristicUUID);
        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', handleNotify);
        statusEl.textContent = 'Status: Connected to ' + (device.name || 'ESP32');
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Status: Connection failed';
      }
    };

    // Expect "d=...,v=...,score=...,p=..."
    function handleNotify(event) {
      const s = new TextDecoder().decode(event.target.value);
      const d = (s.match(/d=(\-?\d+\.?\d*)/) || [])[1];
      const v = (s.match(/v=(\-?\d+\.?\d*)/) || [])[1];
      const sc = (s.match(/score=(\d+)/) || [])[1];
      const p = (s.match(/p=(\d+\.?\d*)/) || [])[1];

      if (d && v) dataEl.textContent = `Distance: ${parseFloat(d).toFixed(2)} | Speed: ${parseFloat(v).toFixed(2)}`;
      if (sc) {
        const score = parseInt(sc, 10);
        scoreEl.textContent = `Score: ${score} | p: ${p ? parseFloat(p).toFixed(2) : '--'}`;

        const t = new Date().toLocaleTimeString();
        chartData.labels.push(t);
        chartData.datasets[0].data.push(score);
        if (chartData.labels.length > 80) { chartData.labels.shift(); chartData.datasets[0].data.shift(); }
        scoreChart.update();

        const li = document.createElement('li');
        li.textContent = `${t} â†’ score=${score}${p ? ` (p=${parseFloat(p).toFixed(2)})` : ''}`;
        scoreLog.prepend(li);
        if (scoreLog.children.length > 120) scoreLog.removeChild(scoreLog.lastChild);
      }
    }

    // Write "S=<int>" threshold
    thresholdSlider.oninput = () => {
      const S = parseInt(thresholdSlider.value, 10);
      thresholdValue.textContent = S;
      if (characteristic) {
        const payload = new TextEncoder().encode(`S=${S}`);
        characteristic.writeValue(payload).catch(err => console.error('Write failed:', err));
      }
    };
    document.getElementById('preset30').onclick = () => { thresholdSlider.value = 30; thresholdSlider.dispatchEvent(new Event('input')); };
    document.getElementById('preset50').onclick = () => { thresholdSlider.value = 50; thresholdSlider.dispatchEvent(new Event('input')); };
    document.getElementById('preset70').onclick = () => { thresholdSlider.value = 70; thresholdSlider.dispatchEvent(new Event('input')); };
    document.getElementById('buzzButton').onclick = () => {
      if (characteristic) {
        const payload = new TextEncoder().encode('buzz');
        characteristic.writeValue(payload).catch(err => console.error('Buzz write failed:', err));
      } else {
        alert('Connect to the device first.');
      }
    };
  </script>
</body>
</html>
