<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StormShield</title>
  <link rel="icon" href="favicon.ico" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --brand:#0A1128;       /* deep navy */
      --brand-2:#173269;     /* hover navy */
      --accent:#1b8a94;      /* teal */
      --muted:#eef2f7;       /* light bg */
      --text:#1e2430;        /* body text */
      --sub:#6b7280;         /* secondary text */
      --card:#ffffff;        /* cards */
      --ring:#cfd8e3;        /* borders */
      --success:#24af37;
      --danger:#d13a30;
      --shadow:0 8px 24px rgba(16,24,40,0.08);
    }

    html{ font-family: Arial, Helvetica, sans-serif; }
    body{ margin:0; background:linear-gradient(180deg,#f6f8fb 0%, #f2f6ff 100%); color:var(--text); }

    /* Header */
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(90deg,var(--brand) 0%, #0c1a42 100%);
      color:#fff; box-shadow:var(--shadow);
    }
    .bar{
      max-width:1100px; margin:0 auto; padding:16px 20px;
      display:flex; align-items:center; justify-content:space-between;
    }
    h1{ margin:0; font-size:1.6rem; letter-spacing:.3px; }
    .status-chip{
      font-size:.9rem; padding:6px 10px; border:1px solid rgba(255,255,255,.25);
      border-radius:999px; display:inline-flex; gap:8px; align-items:center; opacity:.95;
    }
    .status-dot{ width:8px; height:8px; border-radius:50%; background:#aaa; }
    .dot-ok{ background:#5ce27a; }
    .dot-warn{ background:#f0c043; }
    .dot-bad{ background:#ff5a4d; }

    /* Top nav (tabs) */
    .topnav{
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(0,0,0,.05));
      border-top:1px solid rgba(255,255,255,.12);
      border-bottom:1px solid rgba(0,0,0,.08);
      backdrop-filter: blur(6px);
    }
    .tabs{
      max-width:1100px; margin:0 auto; padding:8px 12px;
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    }
    .tab{
      background:transparent; color:#fff; border:1px solid rgba(255,255,255,.25);
      padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700;
      letter-spacing:.2px; transition:.18s ease; user-select:none;
    }
    .tab:hover{ background:rgba(255,255,255,.08); }
    .tab.active{ background:#173269; border-color:#173269; }

    /* Sections */
    section{ display:none; }
    section.active{ display:block; }
    .content{ padding:34px 18px; }
    .wrap{ max-width:1100px; margin:0 auto; }

    /* Cards & grid */
    .card-grid{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      gap:22px;
    }
    .card{
      background:var(--card); border:1px solid var(--ring);
      border-radius:14px; box-shadow:var(--shadow); padding:20px;
      text-align:left;
    }
    .card h3{ margin:0 0 8px 0; font-size:1.15rem; }
    .muted{ color:var(--sub); font-size:.95rem; }

    /* Buttons */
    .btn{
      color:#fff; border:none; cursor:pointer; border-radius:8px; font-size:1rem;
      padding:12px 16px; font-weight:700; letter-spacing:.2px; transition:.18s ease;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn-primary{ background:var(--success); }
    .btn-primary:hover{ filter:brightness(1.05); }
    .btn-ghost{
      background:#fff; color:var(--text); border:1px solid var(--ring);
    }
    .btn-ghost:hover{ background:#f7f9fc; }
    .btn-danger{ background:var(--danger); }
    .btn-teal{ background:var(--accent); }
    .btn-slate{ background:#5f6c6d; }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    /* Range + inputs */
    input[type=range]{ width:100%; }
    .num{ width:120px; padding:10px 12px; border-radius:8px; border:1px solid var(--ring); }

    /* Readouts */
    .reading{
      font-size:1.6rem; font-weight:800; color:var(--accent); margin-top:6px;
    }
    .read-line{ font-size:1rem; color:var(--sub); }

    /* Log */
    #scoreLog{
      list-style:none; margin:0; padding:0; max-height:280px; overflow-y:auto;
      border:1px solid var(--ring); border-radius:10px; background:#fcfdff;
    }
    #scoreLog li{
      padding:10px 12px; border-bottom:1px solid #eef2f7;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:.95rem;
    }
    #scoreLog li:last-child{ border-bottom:none; }

    /* Gallery */
    .gallery{
      display:flex; flex-wrap:wrap; gap:14px; justify-content:center; margin-top:8px;
    }
    .gallery img{
      width:330px; max-width:47%; height:auto; border-radius:12px;
      box-shadow:var(--shadow); object-fit:cover;
    }

    /* Helper chips */
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      background:#f1f6ff; color:#173269; border:1px solid #dbe7ff;
      padding:6px 10px; border-radius:999px; font-weight:700; font-size:.9rem;
    }
    code{ background:#f7fafc; border:1px solid #e5ecf7; padding:2px 6px; border-radius:6px; }

    @media (max-width:600px){
      .gallery img{ max-width:100%; }
      .tabs{ justify-content:flex-start; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="bar">
      <h1>StormShield</h1>
      <div class="status-chip" id="connChip">
        <span class="status-dot" id="connDot"></span>
        <span id="connText">Not connected</span>
      </div>
    </div>
    <div class="topnav">
      <div class="tabs" role="tablist" aria-label="StormShield navigation">
        <button class="tab active" role="tab" aria-selected="true" data-page="dashboard">Dashboard</button>
        <button class="tab" role="tab" aria-selected="false" data-page="settings">Settings</button>
        <button class="tab" role="tab" aria-selected="false" data-page="logs">Logs</button>
        <button class="tab" role="tab" aria-selected="false" data-page="about">About</button>
      </div>
    </div>
  </header>

  <!-- DASHBOARD -->
  <section id="dashboard" class="active" aria-labelledby="Dashboard">
    <div class="content">
      <div class="wrap">
        <div class="card-grid">
          <div class="card">
            <h3>Device</h3>
            <p class="muted">Connect to your ESP32 to start receiving distance/speed, score, and p.</p>
            <div class="row">
              <button class="btn btn-primary" id="connectBtn">ðŸ”— Connect to ESP32</button>
              <button class="btn btn-ghost" id="disconnectBtn" disabled>â›” Disconnect</button>
            </div>
            <div class="reading" id="reading">Distance: -- | Speed: --</div>
            <div class="read-line" id="scoreLine">Score: -- | p: --</div>
          </div>

          <div class="card">
            <h3>Quick Actions</h3>
            <p class="muted">Test the haptic alert and manage the event log.</p>
            <div class="row">
              <button class="btn btn-teal" id="buzzButton">ðŸ”” Test Buzz</button>
              <button class="btn btn-slate" id="clearLog">ðŸ§¹ Clear Log</button>
            </div>
            <p class="muted">Buzz sends <code>buzz</code> to the deviceâ€™s characteristic.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" aria-labelledby="Settings">
    <div class="content">
      <div class="wrap">
        <div class="card-grid">
          <div class="card">
            <h3>Sensitivity / Boundary S</h3>
            <p class="muted">p crosses 0.5 when the score reaches S. Lower S = more sensitive.</p>
            <label class="muted">Boundary S: <strong><span id="thresholdValue">50</span></strong></label>
            <input type="range" id="thresholdSlider" min="0" max="100" step="1" value="50" />
            <div class="row" style="margin-top:6px;">
              <button class="btn btn-teal" id="preset30">Active (30)</button>
              <button class="btn btn-teal" id="preset50">Balanced (50)</button>
              <button class="btn btn-teal" id="preset70">Passive (70)</button>
            </div>
            <p class="muted">Writes both <code>S=&lt;int&gt;</code> (text) and a single byte <code>[0..100]</code> for firmware compatibility.</p>
          </div>

          <div class="card">
            <h3>Logistic Mapping</h3>
            <p class="muted">If firmware does not provide <code>p</code>, the app estimates it.</p>
            <label class="muted" for="kInput">Slope parameter k (higher = gentler transition):</label><br/>
            <input id="kInput" class="num" type="number" step="1" min="1" value="12"/>
            <p class="muted" style="margin-top:10px;">
              Formula: <code>p = 1 / (1 + exp(-(score - S)/k))</code>
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- LOGS -->
  <section id="logs" aria-labelledby="Logs">
    <div class="content">
      <div class="wrap">
        <div class="card-grid">
          <div class="card">
            <h3>Score Timeline</h3>
            <canvas id="scoreChart" height="250"></canvas>
          </div>
          <div class="card">
            <h3>Event Log</h3>
            <ul id="scoreLog"></ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="about" aria-labelledby="About">
    <div class="content">
      <div class="wrap">
        <div class="card">
          <h3>About Storm Shield</h3>
          <p>
            <strong>Storm Shield</strong> is an AI-powered wearable designed by hard-of-hearing athletes, for hard-of-hearing athletes.
            It uses mmWave sensors and Bluetooth alerts to detect motion near the headâ€”improving situational awareness without
            interfering with hearing aids. Risk is computed on-device; this app displays and logs values and estimates
            <code>p</code> if not provided.
          </p>
          <div class="row" style="gap:8px; margin:8px 0;">
            <span class="chip">mmWave + BLE</span>
            <span class="chip">Logistic p</span>
            <span class="chip">Threshold S</span>
            <span class="chip">Charted scores</span>
          </div>
          <div class="gallery">
            <img src="team1.jpg" alt="Competition"/>
            <img src="team2.jpg" alt="Team"/>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    /* ---------- Tab navigation (works even if not connected) ---------- */
    const tabBtns = document.querySelectorAll('.tab');
    function showPage(id){
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      tabBtns.forEach(b => b.classList.toggle('active', b.dataset.page === id));
      if(id==='logs'){ setTimeout(()=> scoreChart.resize(), 150); }
    }
    tabBtns.forEach(b => b.addEventListener('click', () => showPage(b.dataset.page)));

    /* ---------- UI refs ---------- */
    const connDot  = document.getElementById('connDot');
    const connText = document.getElementById('connText');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');

    const readingEl = document.getElementById('reading');
    const scoreLine = document.getElementById('scoreLine');
    const scoreLog  = document.getElementById('scoreLog');

    const thresholdSlider = document.getElementById('thresholdSlider');
    const thresholdValue  = document.getElementById('thresholdValue');
    const kInput = document.getElementById('kInput');

    /* ---------- Chart ---------- */
    const chartCtx = document.getElementById('scoreChart').getContext('2d');
    const chartData = { labels: [], datasets: [{ label:'Score', data:[], borderColor:'#0A1128', backgroundColor:'rgba(10,17,40,0.10)', fill:true, tension:.28, pointRadius:2 }]};
    const scoreChart = new Chart(chartCtx, { type:'line', data:chartData, options:{ responsive:true, scales:{ y:{ beginAtZero:true } } } });
    const MAX_POINTS = 120;

    function addLog(line){
      const li = document.createElement('li');
      li.textContent = line;
      scoreLog.prepend(li);
      while(scoreLog.children.length > 250) scoreLog.removeChild(scoreLog.lastChild);
    }

    /* ---------- Parameters ---------- */
    let S = 50; // boundary for p=0.5
    let k = 12; // logistic slope

    function sigmoid(x){ return 1/(1+Math.exp(-x)); }
    function estP(score){ return sigmoid((score - S)/Math.max(1,k)); }

    /* ---------- BLE (supports both UUID sets & both payload formats) ---------- */
    const UUIDS = [
      { service:'cda3dd4c-e224-4a47-93d3-7c7cc39cb005', char:'8b9843f5-2ed5-4bbd-abec-860f1f5ef2a7' }, // NEW
      { service:'cda3dd4c-e224-4a47-93d3-7c7ccf77e5ad', char:'79e3ff4d-b3e1-4cc1-9096-5c1cbe0a1493' }  // OLD
    ];

    let device = null, server = null, characteristic = null;

    function setConn(status){
      // status: 'off' | 'on' | 'warn'
      connDot.classList.remove('dot-ok','dot-bad','dot-warn');
      if(status==='on'){ connDot.classList.add('dot-ok'); }
      else if(status==='warn'){ connDot.classList.add('dot-warn'); }
      else { connDot.classList.add('dot-bad'); }
    }
    setConn('off');

    async function connectBLE(){
      const optionalServices = UUIDS.map(u=>u.service);
      device = await navigator.bluetooth.requestDevice({ acceptAllDevices:true, optionalServices });
      connText.textContent = 'Connecting...'; setConn('warn');
      server = await device.gatt.connect();
      device.addEventListener('gattserverdisconnected', handleDisconnect);

      for(const u of UUIDS){
        try{
          const service = await server.getPrimaryService(u.service);
          const ch = await service.getCharacteristic(u.char);
          characteristic = ch;
          await characteristic.startNotifications();
          characteristic.addEventListener('characteristicvaluechanged', handleNotify);
          connText.textContent = 'Connected to ' + (device.name || 'ESP32');
          setConn('on');
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          addLog('Connected using service ' + u.service.slice(0,8) + 'â€¦');
          return;
        }catch(e){
          // try next pair
        }
      }
      throw new Error('Expected GATT characteristic not found.');
    }

    function handleDisconnect(){
      addLog('Device disconnected.');
      connText.textContent = 'Not connected';
      setConn('off');
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      characteristic = null; server = null; device = null;
    }

    function handleNotify(event){
      const txt = new TextDecoder().decode(event.target.value);

      // Pattern A: D<dist>,S<speed>
      let m = txt.match(/D(\d+\.?\d*),S(\d+\.?\d*)/i);
      if(m){
        const d = parseFloat(m[1]); const v = parseFloat(m[2]);
        const score = (d>0 ? (100.0/d) : 0) + v;
        const p = estP(score);
        updateUI(d, v, score, p, '(local p)');
        return;
      }

      // Pattern B: d=..., v=..., score=..., p=...
      const dM = txt.match(/d=(\-?\d+\.?\d*)/i);
      const vM = txt.match(/v=(\-?\d+\.?\d*)/i);
      const sM = txt.match(/score=(\-?\d+\.?\d*)/i);
      const pM = txt.match(/p=(\-?\d+\.?\d*)/i);

      if(dM || vM || sM || pM){
        const d = dM ? parseFloat(dM[1]) : NaN;
        const v = vM ? parseFloat(vM[1]) : NaN;
        const score = sM ? parseFloat(sM[1]) : NaN;
        const p = pM ? parseFloat(pM[1]) : (isFinite(score) ? estP(score) : NaN);
        updateUI(d, v, score, p, pM ? '(fw p)' : '(local p)');
        return;
      }

      addLog('Unrecognized: ' + txt);
    }

    function updateUI(d, v, score, p, tag){
      if(isFinite(d) && isFinite(v)){
        readingEl.textContent = `Distance: ${d.toFixed(2)} | Speed: ${v.toFixed(2)}`;
      }
      if(isFinite(score)){
        const pTxt = isFinite(p) ? p.toFixed(2) : '--';
        scoreLine.textContent = `Score: ${score.toFixed(2)} | p: ${pTxt} ${tag?tag:''}`;

        const t = new Date().toLocaleTimeString();
        chartData.labels.push(t);
        chartData.datasets[0].data.push(score);
        if(chartData.labels.length > MAX_POINTS){
          chartData.labels.shift(); chartData.datasets[0].data.shift();
        }
        scoreChart.update();
        addLog(`${t} â†’ score=${score.toFixed(2)}${isFinite(p) ? ` (p=${p.toFixed(2)})` : ''}`);
      }
    }

    /* ---------- Event bindings ---------- */
    connectBtn.addEventListener('click', async ()=>{
      try{ await connectBLE(); }
      catch(e){ addLog('Connect error: ' + e.message); connText.textContent='Connection failed'; setConn('off'); }
    });

    disconnectBtn.addEventListener('click', ()=>{
      try{
        if(device && device.gatt.connected){ device.gatt.disconnect(); }
        handleDisconnect();
      }catch(e){ addLog('Disconnect error: ' + e.message); }
    });

    document.getElementById('buzzButton').addEventListener('click', async ()=>{
      if(!characteristic){ addLog('Buzz skipped: not connected.'); return; }
      try{
        await characteristic.writeValue(new TextEncoder().encode('buzz'));
        addLog('Sent: buzz');
      }catch(e){ addLog('Buzz failed: ' + e.message); }
    });

    document.getElementById('clearLog').addEventListener('click', ()=> { scoreLog.innerHTML=''; });

    // S slider (writes both text & byte when connected; still usable when not)
    thresholdSlider.addEventListener('input', async ()=>{
      S = parseInt(thresholdSlider.value, 10);
      thresholdValue.textContent = S;
      if(characteristic){
        try{
          await characteristic.writeValue(new TextEncoder().encode(`S=${S}`));
          await characteristic.writeValue(new Uint8Array([S & 0xFF]));
          addLog(`Wrote threshold: S=${S} (text & byte)`);
        }catch(e){ addLog('Write S failed: ' + e.message); }
      }
    });

    // Presets
    document.getElementById('preset30').addEventListener('click', ()=>{ thresholdSlider.value=30; thresholdSlider.dispatchEvent(new Event('input')); });
    document.getElementById('preset50').addEventListener('click', ()=>{ thresholdSlider.value=50; thresholdSlider.dispatchEvent(new Event('input')); });
    document.getElementById('preset70').addEventListener('click', ()=>{ thresholdSlider.value=70; thresholdSlider.dispatchEvent(new Event('input')); });

    // k
    kInput.addEventListener('change', ()=>{
      const v = parseFloat(kInput.value);
      if(isFinite(v) && v>0) k = v;
    });
  </script>
</body>
</html>
